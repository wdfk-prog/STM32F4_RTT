# CANOEPN转MODBUS调试说明

[TOC]



## 版本修订履历

| 版本号 | 修订日期   | 修订作者 | 修订内容     |
| ------ | ---------- | -------- | ------------ |
| V1.0.0 | 2022/11/12 | Hly      | 创建基础版本 |

## 1.节点查看与设置

### 1.1设置节点ID

对**寄存器**地址0x01写入节点ID进行节点设置。可以进行对该节点的查看与设置。并默认使用该节点ID进行其他步骤操作。

|寄存器种类|读取地址|数据类型|参数范围|默认值|备注|
| --------------- | -------------------------- | --------------- | -------------------------- | --------------- | --------------- |
|保持寄存器|1| uint16   | 1~节点数[1.1.2查看节点数](#1.1.2查看节点数) | 1      |设置需操作的节点ID|

### 1.2查看节点数

读取**输入寄存器**地址0X01查看总线节点数量，节点数量为本机节点(主节点)+从机节点数。

| 寄存器种类 | 读取地址 | 数据类型 | 参数范围 | 默认值 | 备注             |
| ---------- | -------- | -------- | -------- | ------ | ---------------- |
| 输入寄存器 | 1        | uint16   | 1~128    | 1      | 查看总线节点数量 |

### 1.3查看节点当前NMT状态

NMT状态分为如下几个状态,一般节点进入Operational状态即正常，其他状态异常。

```c
/* The nodes states 
 * -----------------
 * values are choosen so, that they can be sent directly
 * for heartbeat messages...
 * Must be coded on 7 bits only
 * */
/* Should not be modified */
enum enum_nodeState {
  Initialisation  = 0x00, //节点上电
  Disconnected    = 0x01, //节点丢失
  Connecting      = 0x02, //节点连接
  Preparing       = 0x02, //节点准备阶段
  Stopped         = 0x04, //节点停止
  Operational     = 0x05, //节点可操作状态
  Pre_operational = 0x7F, //节点预操作状态
  Unknown_state   = 0x0F  //节点未知状态
};
```

读取**输入寄存器**地址0X02来获取设置节点的NMT状态。默认查看主节点(节点ID = 0x01)状态，查看其他节点状态需设置节点ID。[1.1.1设置节点ID](#1.1.1设置节点ID)

| 寄存器种类 | 读取地址 | 数据类型 | 参数范围       | 默认值 | 备注         |
| ---------- | -------- | -------- | -------------- | ------ | ------------ |
| 输入寄存器 | 2        | uint16   | enum_nodeState | 0x0F   | 查看节点状态 |

### 1.4查看节点名称

读取**输入寄存器**地址0X03至0X0B来获取设置节点的名称。默认查看主节点(节点ID = 0x01)名称，查看其他节点名称需设置节点ID。[1.1.1设置节点ID](#1.1.1设置节点ID)

字符串长度为8个8位数据，即占用4个输入寄存器。字符串格式为UTF-8,若显示异常，需将高低16位调换。

| 寄存器种类 | 读取地址    | 数据类型   | 参数范围    | 默认值 | 备注           |
| ---------- | ----------- | ---------- | ----------- | ------ | -------------- |
| 输入寄存器 | 3~6         | string     | 无          | 无     | 查看节点名称   |
| 输入寄存器 | 3           | string     | 无          | 无     | 节点名称开始   |
| ........   | ........... | .......... | ........... | .....  | 节点名称中间值 |
| 输入寄存器 | 6           | string     | 无          | 无     | 节点名称结束   |

例如查看主节点(节点ID = 0x01)的名称为"master",输入寄存器0X03至0X0B值为

| 地址 | 值(16进制) | 字符       |
| ---- | ---------- | ---------- |
| 0x03 | 0X616D     | am         |
| 0x04 | 0X7473     | ts         |
| 0x05 | 0X7265     | re         |
| 0x06 | 0X0000     | NUL (NULL) |

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\查看节点名称.png)

### 1.5查看节点错误代码

节点错误代码0X00~0XFF为自定义错误代码。

```c
/** 
  * @brief  节点错误代码
  */  
typedef enum
{
  NODEID_CONFIG_SUCCESS,      //节点配置成功
  NODEID_BACK_ONLINE,         //节点重新上线
  NODEID_CONFIG_NO_RESPOND,   //配置回复未响应，节点字典出错
  NODEID_CONFIG_NO_SEND,      //配置未发送,本地字典出错
}NODEID_ERRCODE;
```

其余错误代码为EMCY错误代码。

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\EMCY错误代码.png)

| 寄存器种类 | 读取地址 | 数据类型 | 参数范围 | 默认值 | 备注             |
| ---------- | -------- | -------- | -------- | ------ | ---------------- |
| 输入寄存器 | 7        | uint16   | 无       | 0x00   | 查看节点错误代码 |

例如:节点2心跳错误，错误代码为0X8130,查看EMCY错误代码为**节点守护错误**.

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\节点心跳错误.png)

节点2配置错误，错误代码为0X0002，查看枚举为**配置回复未响应，节点字典出错**.

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\节点配置错误.png)

## 2.电机查看与设置

对节点ID进行设置后[1.1.1设置节点ID](#1.1.1设置节点ID)，该节点若是DS402协议，即电机节点，既可进行电机操作。

### 2.1电机使能与禁用

对**线圈寄存器**地址0X01写入True使能电机控制，写入False禁用电机。

| 寄存器种类 | 读取地址 | 默认值 | 备注         |
| ---------- | -------- | ------ | ------------ |
| 线圈寄存器 | 1        | 0      | 电机使能控制 |

### 2.2电机模式设置

对**保持寄存器**地址0x0B写入参数进行模式设置。

参数范围如下:

| 模式            | **寄存器**地址0x01写入参数 | 备注       |
| --------------- | -------------------------- | ---------- |
| PP,位置规划模式 | 1                          | 无附加参数 |
| IP,插补位置模式 | 2                          | 不可使用   |
| HM,原点复归模式 | 4                          | 有附加参数 |
| PV,速度规划模式 | 8                          | 无附加参数 |

#### 2.2.1 PP,位置规划模式

#### 2.2.2 IP,插补位置模式

#### 2.2.3 HM,原点复归模式

#### 2.2.4 PV,速度规划模式

## 附录

### 保持寄存器列表

| 寄存器种类 | 读取地址 | 数据类型 | 参数范围 | 默认值 | 备注             |
| ---- | ---- | ---- | ---- | ---- | ---- |
| 保持寄存器 | 1 | uint16 | 0~128 | 1~节点数[1.1.2查看节点数](#1.1.2查看节点数) | 设置需操作的节点ID |
| 保持寄存器 | 2~10 | uint16   | ... | ... | CAN保留区域 |
| 保持寄存器 | 11       | uint16 | 1~8 | 0 | 电机模式设置       |
|      |      |      |      |      |      |
|      |      |      |      |      |      |
|      |      |      |      |      |      |
|      |      |      |      |      |      |
|      |      |      |      |      |      |
|      |      |      |      |      |      |

### 输入寄存器列表

| 寄存器种类 | 读取地址    | 数据类型   | 参数范围       | 默认值 | 备注             |
| ---------- | ----------- | ---------- | -------------- | ------ | ---------------- |
| 输入寄存器 | 1           | uint16     | 1~65535        | 1      | 查看总线节点数量 |
| 输入寄存器 | 2           | uint16     | enum_nodeState | 0x0F   | 查看节点状态     |
| 输入寄存器 | 3~6         | string     | 无             | 无     | 查看节点名称     |
| 输入寄存器 | 3           | string     | 无             | 无     | 节点名称开始     |
| ........   | ........... | .......... | ...........    | .....  | 节点名称中间值   |
| 输入寄存器 | 6           | string     | 无             | 无     | 节点名称结束     |
| 输入寄存器 | 7           | uint16     | 无             | 0x00   | 查看节点错误代码 |
| 输入寄存器 | 8~10        | .......... | ...........    | .....  | CAN保留区域      |
|            |             |            |                |        |                  |
|            |             |            |                |        |                  |
|            |             |            |                |        |                  |
|            |             |            |                |        |                  |
|            |             |            |                |        |                  |
|            |             |            |                |        |                  |

### 线圈寄存器

| 寄存器种类 | 读取地址 | 默认值 | 备注         |
| ---------- | -------- | ------ | ------------ |
| 线圈寄存器 | 1        | 0      | 电机使能控制 |



### 离散输入线圈寄存器

| 寄存器种类         | 读取地址 | 默认值 | 备注 |
| ------------------ | -------- | ------ | ---- |
| 离散输入线圈寄存器 |          |        |      |
