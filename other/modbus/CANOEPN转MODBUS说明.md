# CANOEPN转MODBUS调试说明

[TOC]



## 版本修订履历

| 版本号 | 修订日期   | 修订作者 | 修订内容     |
| ------ | ---------- | -------- | ------------ |
| V1.0.0 | 2022/11/12 | Hly      | 创建基础版本 |

## 1.节点查看与设置

### 1.1设置节点ID

对**寄存器**地址01D写入节点ID进行节点设置。可以进行对该节点的查看与设置。并默认使用该节点ID进行其他步骤操作。

|寄存器种类|地址|数据类型|参数范围|默认值|备注|
| --------------- | -------------------------- | --------------- | -------------------------- | --------------- | --------------- |
|保持寄存器|01D| uint16   | 1~节点数[1.1.2查看节点数](#1.1.2查看节点数) | 0X01 |设置需操作的节点ID|

### 1.2查看节点数

读取**输入寄存器**地址01D查看总线节点数量，节点数量为本机节点(主节点)+从机节点数。

| 寄存器种类 | 地址 | 数据类型 | 参数范围 | 默认值 | 备注             |
| ---------- | ---- | -------- | -------- | ------ | ---------------- |
| 输入寄存器 | 01D  | uint16   | 1~128    | 0X01   | 查看总线节点数量 |

### 1.3查看节点当前NMT状态

NMT状态分为如下几个状态,一般节点进入Operational状态即正常，其他状态异常。

```c
/* The nodes states 
 * -----------------
 * values are choosen so, that they can be sent directly
 * for heartbeat messages...
 * Must be coded on 7 bits only
 * */
/* Should not be modified */
enum enum_nodeState {
  Initialisation  = 0x00, //节点上电
  Disconnected    = 0x01, //节点丢失
  Connecting      = 0x02, //节点连接
  Preparing       = 0x02, //节点准备阶段
  Stopped         = 0x04, //节点停止
  Operational     = 0x05, //节点可操作状态
  Pre_operational = 0x7F, //节点预操作状态
  Unknown_state   = 0x0F  //节点未知状态
};
```

读取**输入寄存器**地址02D来获取设置节点的NMT状态。默认查看主节点(节点ID = 0x01)状态，查看其他节点状态需设置节点ID。[1.1.1设置节点ID](#1.1.1设置节点ID)

| 寄存器种类 | 地址 | 数据类型 | 参数范围       | 默认值 | 备注         |
| ---------- | ---- | -------- | -------------- | ------ | ------------ |
| 输入寄存器 | 02D  | uint16   | enum_nodeState | 0x0F   | 查看节点状态 |

### 1.4查看节点名称

读取**输入寄存器**地址0X03至0X0B来获取设置节点的名称。默认查看主节点(节点ID = 0x01)名称，查看其他节点名称需设置节点ID。[1.1.1设置节点ID](#1.1.1设置节点ID)

字符串长度为8个8位数据，即占用4个输入寄存器。字符串格式为UTF-8,若显示异常，需将高低16位调换。

| 寄存器种类 | 地址        | 数据类型   | 参数范围    | 默认值 | 备注           |
| ---------- | ----------- | ---------- | ----------- | ------ | -------------- |
| 输入寄存器 | 03D~06D     | string     | 无          | 无     | 查看节点名称   |
| 输入寄存器 | 03D         | string     | 无          | 无     | 节点名称开始   |
| ........   | ........... | .......... | ........... | .....  | 节点名称中间值 |
| 输入寄存器 | 06D         | string     | 无          | 无     | 节点名称结束   |

例如查看主节点(节点ID = 0x01)的名称为"master",输入寄存器0X03至0X0B值为

| 地址 | 值(16进制) | 字符       |
| ---- | ---------- | ---------- |
| 03D  | 0X616D     | am         |
| 04D  | 0X7473     | ts         |
| 05D  | 0X7265     | re         |
| 06D  | 0X0000     | NUL (NULL) |

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\查看节点名称.png)

### 1.5查看节点错误代码

节点错误代码0X00~0XFF为自定义错误代码。

```c
/** 
  * @brief  节点错误代码
  */  
typedef enum
{
  NODEID_CONFIG_SUCCESS,      //节点配置成功
  NODEID_BACK_ONLINE,         //节点重新上线
  NODEID_CONFIG_NO_RESPOND,   //配置回复未响应，节点字典出错
  NODEID_CONFIG_NO_SEND,      //配置未发送,本地字典出错
}NODEID_ERRCODE;
```

其余错误代码为EMCY错误代码。

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\EMCY错误代码.png)

| 寄存器种类 | 地址 | 数据类型 | 参数范围 | 默认值 | 备注             |
| ---------- | ---- | -------- | -------- | ------ | ---------------- |
| 输入寄存器 | 07D  | uint16   | 无       | 0x00   | 查看节点错误代码 |

- 例如:节点2心跳错误，错误代码为0X8130,查看EMCY错误代码为**节点守护错误**.

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\节点心跳错误.png)

- 例如:节点2配置错误，错误代码为0X0002，查看枚举为**配置回复未响应，节点字典出错**.

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\节点配置错误.png)

## 2.电机查看与设置

对节点ID进行设置后[1.1.1设置节点ID](#1.1.1设置节点ID)，该节点若是DS402协议，即电机节点，既可进行电机操作。

### 2.1电机使能与禁用

对**线圈寄存器**地址01D写入True使能电机控制，写入False禁用电机。

| 寄存器种类 | 地址 | 默认值 | 备注         |
| ---------- | ---- | ------ | ------------ |
| 线圈寄存器 | 01D  | 0X00   | 电机使能控制 |

### 2.2电机模式设置

#### 2.2.1 模式设置说明

对**保持寄存器**地址11D写入参数进行模式设置。

```c
/*0X6060 模式设定Modes of operation定义*/
typedef enum
{
  PROFILE_POSITION_MODE       = 1,//位置规划模式
  PROFILE_VELOCITY_MODE       = 3,//速度规划模式
  PROFILE_TORQUE_MODE         = 4,//扭矩规划模式
  HOMING_MODE                 = 6,//原点复归模式
  INTERPOLATED_POSITION_MODE  = 7,//插补位置模式
}MODE_OPERATION;
```

**参数范围如下:**

| 模式            | 保持寄存器地址11D写入参数 | 备注          |
| --------------- | ------------------------- | ------------- |
| PP,位置规划模式 | 01D                       | 无附加参数    |
| PV,速度规划模式 | 03D                       | 无附加参数    |
| PT,扭矩规划模式 | 04D                       | 不可使用      |
| HM,原点复归模式 | 06D                       | 有4个附加参数 |
| IP,插补位置模式 | 07D                       | 不可使用      |

#### 2.2.2 原点复归模式，附加参数说明

| 保持寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                          |
| -------------- | -------- | -------- | ------ | ----------------------------- |
| 12D~13D        | int32    | 无       | 0      | 设置原点偏移值 单位PUU        |
| 14D            | uint16   | 0 ~ 35   | 34     | 回原方式                      |
| 15D            | uint16   | 1 ~ 2000 | 100    | 寻找原点开关速度 单位0.1rpm   |
| 16D            | uint16   | 1 ~ 500  | 20     | 寻找 Z脉冲速度     单位0.1rpm |

- 原点偏移值:单位:PUU [注意:只是把原点偏移值点当为0坐标点，并不会运动到0坐标点处]

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\PUU.png)

- 回原方式: 范围:0 ~ 35

- 寻找原点开关速度:设定范围 0.1 ~ 200 默认值 10  单位0.1rpm

- 寻找 Z脉冲速度:     设定范围 0.1 ~ 50  默认值 2   单位0.1rpm

#### 2.2.3 电机模式相关保持寄存器列表

| 寄存器种类 | 地址    | 数据类型 | 参数范围 | 默认值 | 备注             |
| ---------- | ------- | -------- | -------- | ------ | ---------------- |
| 保持寄存器 | 11D     | uint16   | 1~7      | 0      | 设置电机模式     |
| 保持寄存器 | 12D~13D | int32    | 无       | 0      | 设置原点偏移值   |
| 保持寄存器 | 14D     | uint16   | 0~35     | 0      | 回原方式         |
| 保持寄存器 | 15D     | uint16   | 1 ~ 2000 | 10     | 寻找原点开关速度 |
| 保持寄存器 | 16D     | uint16   | 1 ~ 500  | 20     | 寻找 Z脉冲速度   |

### 2.3电机使用

- 对电机进行使能后[2.1电机使能与禁用](#2.1电机使能与禁用)，设置电机模式来对电机上电。
- 设置电机模式后，对相应电机运动参数写入进行控制电机运动。
- 对电机进行禁用后[2.1电机使能与禁用](#2.1电机使能与禁用)，电机掉电并清除当前设置的电机模式。

#### 2.3.1 PP,位置规划模式

伺服驱动器接收到由上位机传送的位置命令后，驱动器控制伺服电机到达目标位置。在位置控制模式下，上位机仅在一开始时告知驱动器目标位置、速度命令与加减速等相关设定。从命令触发到到达目标位置这中间的运动规划，都是由驱动器内部的运动命令产生器去执行。

- 电机运动参数

| 寄存器种类 | 地址    | 数据类型 | 参数范围 | 默认值 | 备注                 |
| ---------- | ------- | -------- | -------- | ------ | -------------------- |
| 保持寄存器 | 11D     | uint16   | 1~7      | 0      | 设置电机模式         |
| 保持寄存器 | 17D~18D | int32    | 无       | 0      | 目标位置    单位 PUU |
| 保持寄存器 | 19D     | int16    | 无       | 60     | 速度 单位RPM         |
| 保持寄存器 | 20D     | uint16   | 0 、 1   | 0      | 运动模式             |
| 保持寄存器 | 21D     | uint16   | 0、  1   | 0      | 生效指令             |

- 运动模式:设为0，绝对运动模式；设为1，相对运动模式
- 命令立即生效指令。 设为 0，关闭命令立即生效指令 1，立刻生效，即未到达目标位置也可执行下次运动

**函数原型如下**

```c
/**
  * @brief  控制电机以位置规划模式运动
  * @param  position:   位置    单位PUU 脉冲个数
  * @param  speed:      速度    单位RPM
  * @param  abs_rel:    运动模式。 设为0，绝对运动模式；设为1，相对运动模式
  * @param  immediately:命令立即生效指令。 设为 0，关闭命令立即生效指令 1，立刻生效，即未到达目标位置也可执行下次运动
  * @param  nodeId:节点ID
  * @retval 成功返回0X00,失败返回0XFF
  * @note   可以重复此函数用来控制电机运动不同位置。
  */
UNS8 motor_profile_position(int32_t position,int16_t speed,bool abs_rel,bool immediately,UNS8 nodeId)
```

#### 2.3.2 PV,速度规划模式

在 PV (速度规划) 模式下，上位机指定速度命令与加减速等条件，并由驱动器的运动命令产生器依据这些条件规划出运动轨迹.

- 电机运动参数

| 寄存器种类 | 地址 | 数据类型 | 参数范围 | 默认值 | 备注         |
| ---------- | ---- | -------- | -------- | ------ | ------------ |
| 保持寄存器 | 11D  | uint16   | 1~7      | 0      | 设置电机模式 |
| 保持寄存器 | 17D  | int16    | 无       | 60     | 速度 单位RPM |

**函数原型**

```c
/**
  * @brief  控制电机以速度规划模式运动
  * @param  speed:      速度    单位RPM
  * @param  nodeId:节点ID
  * @retval 成功返回0X00,失败返回0XFF
  * @note   可以重复此函数用来控制电机运动不同位置。 置一od 0x2124开启S型加减速
  */
UNS8 motor_profile_velocity(int16_t speed,UNS8 nodeId)
```



#### 2.3.3 PT,扭矩规划模式

- 未编写

#### 2.3.4 HM,原点复归模式

在执行完成原点复归后，驱动器的坐标系即建立，驱动器可开始执行上位机所下达的位置命令。根据驱动器提供原点复归模式进行选择，包含找寻原点开关、正负极限、电机 Z脉冲等模式。

- 先对保持寄存器11D写入06D，进入原点复归模式.设置12D~15D相关参数,具体参数设置查看[2.2.2 原点复归模式，附加参数说明](#2.2.2 原点复归模式，附加参数说明).电机进入使能状态。

- 电机模式设置

  | 保持寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                          |
  | -------------- | -------- | -------- | ------ | ----------------------------- |
  | 12D~13D        | int32_t  | 无       | 0      | 设置原点偏移值 单位PUU        |
  | 14D            | uint16   | 0 ~ 35   | 34     | 回原方式                      |
  | 15D            | uint16   | 1 ~ 2000 | 100    | 寻找原点开关速度 单位0.1rpm   |
  | 16D            | uint16   | 1 ~ 500  | 20     | 寻找 Z脉冲速度     单位0.1rpm |

  电机运动参数

  | 寄存器种类 | 地址 | 数据类型 | 参数范围 | 默认值 | 备注         |
  | ---------- | ---- | -------- | -------- | ------ | ------------ |
  | 保持寄存器 | 11D  | uint16   | 1~7      | 0      | 设置电机模式 |
  | 保持寄存器 | 17D  | uint16   | 0、1     | 0      | 是否返回零点 |

- 是否返回零点：0，无需返回0点位置。 zero_flag：1，返回0点位置。

**函数原型如下**

```c
/**
  * @brief  控制电机使能并选择原点复位模式
  * @param  offest:原点偏移值 单位:PUU [注意:只是把原点偏移值点当为0坐标点，并不会运动到0坐标点处]
  * @param  method:回原方式   范围:0 ~ 35
  * @param  switch_speed:寻找原点开关速度 设定范围 0.1 ~ 200 默认值 10  单位rpm 精度:小数点后一位
  * @param  zero_speed:寻找 Z脉冲速度     设定范围 0.1 ~ 50  默认值 2   单位rpm 精度:小数点后一位
  * @param  nodeId:节点ID
  * @retval 成功返回0X00,失败返回0XFF
  * @note   None
*/
UNS8 motor_on_homing_mode(int32_t offset,uint8_t method,float switch_speed,float zero_speed,UNS8 nodeId)
/**
  * @brief  控制电机进入原点复归模式
  * @param  zero_flag：0，无需返回0点位置。 zero_flag：1，返回0点位置
  * @param  nodeId:节点ID
  * @retval 成功返回0X00,失败返回0XFF.
  * @note   None
*/
UNS8 motor_homing_mode (bool zero_flag,UNS8 nodeId)
```



#### 2.3.5 IP,插补位置模式

- 无法使用

## 附录

### 保持寄存器列表

| 地址 | 数据类型 | 参数范围 | 默认值   | 备注                          |
| ---- | ---- | ---- | ---- | ---- |
| 01D     | uint16   | 0~128    | 1~节点数 | 设置需操作的节点ID            |
| 02D~10D | uint16   | ...      | ...      | CAN保留区域                   |
| 11D20   | uint16   | 1~7      | 0        | 设置电机模式                  |
| 12D~13D | int32    | 无       | 0        | 设置原点偏移值 单位PUU        |
| 14D     | uint16   | 0 ~ 35   | 34       | 回原方式                      |
| 15D     | uint16   | 1 ~ 2000 | 100      | 寻找原点开关速度 单位0.1rpm   |
| 16D     | uint16   | 1 ~ 500  | 20       | 寻找 Z脉冲速度     单位0.1rpm |
| 17D | int16 | 无 | 0 | 电机运动参数1 |
| 18D | int16 | 无 | 0        | 电机运动参数2 |
| 19D | int16 | 无 | 0 | 电机运动参数3 |
| 20D | int16 | 无 | 0 | 电机运动参数4 |
| 21D | int16 | 无 | 0 | 电机运动参数5 |
| 22D~30D | uint16 | ... | ... | 电机保留区域 |
| 31D | | | | |
| | | | | |
| | | | | |
| | | | | |
| | | | | |
| | | | | |

### 输入寄存器列表

| 地址        | 数据类型   | 参数范围       | 默认值 | 备注             |      |
| ----------- | ---------- | -------------- | ------ | ---------------- | ---- |
| 01D         | uint16     | 1~128          | 1      | 查看总线节点数量 |      |
| 02D         | uint16     | enum_nodeState | 0x0F   | 查看节点状态     |      |
| 03D~06D     | string     | 无             | 无     | 查看节点名称     |      |
| 03D         | string     | 无             | 无     | 节点名称开始     |      |
| ........... | .......... | ...........    | .....  | 节点名称中间值   |      |
| 06D         | string     | 无             | 无     | 节点名称结束     |      |
| 07D         | uint16     | 无             | 0x00   | 查看节点错误代码 |      |
| 08D~10D     | .......... | ...........    | .....  | CAN保留区域      |      |
|             |            |                |        |                  |      |
|             |            |                |        |                  |      |
|             |            |                |        |                  |      |
|             |            |                |        |                  |      |
|             |            |                |        |                  |      |
|             |            |                |        |                  |      |

### 线圈寄存器

| 地址 | 默认值 | 备注         |
| ---- | ------ | ------------ |
| 01D  | 0      | 电机使能控制 |

### 离散输入线圈寄存器

| 地址 | 默认值 | 备注 |      |
| ---- | ------ | ---- | ---- |
|      |        |      |      |
