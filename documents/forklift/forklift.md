# 激光叉车MODBUS通讯说明

[TOC]



## 版本修订履历

| 版本号 | 修订日期   | 修订作者 | 修订内容     |
| ------ | ---------- | -------- | ------------ |
| V1.0.0 | 2022/11/21 | Hly      | 创建基础版本 |

|      |      |      |      |      |
| ---- | ---- | ---- | ---- | ---- |
|      |      |      |      |      |
|      |      |      |      |      |

## 1. 电机运动控制

### 1.1 转向电机使能

- 默认上电即使能电机，既可控制电机运动
- 对线圈寄存器地址11D写入0X01，使能电机，控制电机运动
- 写入0X00，禁用电机，禁用电机将关闭电机使能状态，禁用电机运动。

| 线圈寄存器地址 | 默认值 | 备注         |
| -------------- | ------ | ------------ |
| 11D            | 0X01   | 转向电机使能 |

### 1.2 转向电机运动

#### 1.2.1 转向电机角度设置

- 设置电机角度,默认值为当前反馈角度。单位:0.001°
- 角度范围默认-180~180度，超出角度范围将只能运动到最大角度范围，并反馈角度超出范围标志。[1.3.3 转向电机角度超出范围标志查询](#1.3.3 转向电机角度超出范围标志查询)。可通过设置角度范围调整[1.2.3 转向电机角度范围设置](#1.2.3 转向电机角度范围设置)。

| 保持寄存器地址 | 数据类型 | 参数范围 | 默认值       | 备注                            |
| -------------- | -------- | -------- | ------------ | ------------------------------- |
| 41D~42D        | float    | -180~180 | 当前反馈角度 | 转向电机[1]角度输入 单位:0.001° |
| 43D~44D        | float    | -180~180 | 当前反馈角度 | 转向电机[2]角度输入 单位:0.001° |
| 45D~46D        | float    | -180~180 | 当前反馈角度 | 转向电机[3]角度输入 单位:0.001° |
| 47D~48D        | float    | -180~180 | 当前反馈角度 | 转向电机[4]角度输入 单位:0.001° |

- 例如:设置转向电机[1]角度为90°，寄存器内容为

```shell
num: 41|hold:24464#num: 42|hold:    1#
angle = (1<<16 + 24464)  /  1000 = 90.000

```

#### 1.2.2 转向电机速度设置

- 设置电机速度，单位:0.1RPM,默认值60RPM,范围：0~2000RPM

| 保持寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                            |
| -------------- | -------- | -------- | ------ | ------------------------------- |
| 49D            | uint16   | 0~20000  | 600    | 转向电机[1]速度输入 单位:0.1RPM |
| 50D            | uint16   | 0~20000  | 600    | 转向电机[2]速度输入 单位:0.1RPM |
| 51D            | uint16   | 0~20000  | 600    | 转向电机[3]速度输入 单位:0.1RPM |
| 52D            | uint16   | 0~20000  | 600    | 转向电机[4]速度输入 单位:0.1RPM |

- 例如：设置转向电机[1]速度为100RPM，寄存器内容为：

```shell
num: 49|hold: 1000#
speed = 1000 / 10 = 100 rpm
```

#### 1.2.3 转向电机角度范围设置

- 设置电机角度范围，单位:°。默认值最大角度180,最小角度-180。
- 超出角度范围将只能运动到最大角度范围，并反馈角度超出范围标志。[2.3.3 转向电机角度超出范围标志查询](#2.3.3 转向电机角度超出范围标志查询)。

| 保持寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                       |
| -------------- | -------- | -------- | ------ | -------------------------- |
| 53D            | int16    | 无       | 180    | 转向电机[1]最大角度 单位:° |
| 54D            | int16    | 无       | -180   | 转向电机[1]最小角度 单位:° |
| 55D            | int16    | 无       | 180    | 转向电机[2]最大角度 单位:° |
| 56D            | int16    | 无       | -180   | 转向电机[2]最小角度 单位:° |
| 57D            | int16    | 无       | 180    | 转向电机[3]最大角度 单位:° |
| 58D            | int16    | 无       | -180   | 转向电机[3]最小角度 单位:° |
| 59D            | int16    | 无       | 180    | 转向电机[4]最大角度 单位:° |
| 60D            | int16    | 无       | -180   | 转向电机[4]最小角度 单位:° |

### 1.3 转向电机反馈信息

#### 1.3.1 转向电机角度查询

| 输入寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                             |
| -------------- | -------- | -------- | ------ | -------------------------------- |
| 41D~42D        | float    | -180~180 | 0      | 转向电机[1]反馈角度  单位:0.001° |
| 43D~44D        | float    | -180~180 | 0      | 转向电机[2]反馈角度 单位:0.001°  |
| 45D~46D        | float    | -180~180 | 0      | 转向电机[3]反馈角度 单位:0.001°  |
| 47D~48D        | float    | -180~180 | 0      | 转向电机[4]反馈角度 单位:0.001°  |

#### 1.3.2 转向电机速度查询

| 输入寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                            |
| -------------- | -------- | -------- | ------ | ------------------------------- |
| 49D            | int16    | 无       | 0      | 转向电机[1]反馈速度 单位:0.1RPM |
| 45D            | int16    | 无       | 0      | 转向电机[2]反馈速度 单位:0.1RPM |
| 51D            | int16    | 无       | 0      | 转向电机[3]反馈速度 单位:0.1RPM |
| 52D            | int16    | 无       | 0      | 转向电机[4]反馈速度 单位:0.1RPM |

#### 1.3.3 转向电机角度超出范围标志查询

- 保存至离散线圈输入寄存器地址0X01D中。0x00,角度未超出范围。0x01,角度超出范围。
- 当输入角度在范围内时，超出范围标志自动清零。

| 离散线圈输入寄存器地址 | 默认值 | 备注                        |
| ---------------------- | ------ | --------------------------- |
| 01D                    | 0X00   | 转向电机[1]角度超出范围标志 |
| 02D                    | 0X00   | 转向电机[2]角度超出范围标志 |
| 03D                    | 0X00   | 转向电机[3]角度超出范围标志 |
| 04D                    | 0X00   | 转向电机[4]角度超出范围标志 |

#### 1.3.4 转向电机停止代码查询

- 停止代码定义如下，各个停止事件可用或运算累计
- 查看该值的各个位既可知晓当前停止原因

```c
/** 
  * @brief  停止代码
  */  
typedef enum
{
  NO_STOP = 0x00U,//无停止            0x00
  HARD_STOP,      //硬件急停          0x02
  SOFT_STOP     , //软急停            0x04
  Detection_STOP, //心跳异常          0x08
  ENABLE_STOP   , //电机关闭使能      0x10
  ALM_STOP      , //报警报警          0X20
  CRASH_STOP    , //防撞条报警        0X40
  VBATT_STOP    , //电压过低报警      0X80
  BEAT_STOP    ,  //心跳异常          0X100
}Stop_Code;
```



| 输入寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                |
| -------------- | -------- | -------- | ------ | ------------------- |
| 53D            | uint16   | 无       | 0      | 转向电机[1]停止代码 |
| 54D            | uint16   | 无       | 0      | 转向电机[2]停止代码 |
| 55D            | uint16   | 无       | 0      | 转向电机[3]停止代码 |
| 56D            | uint16   | 无       | 0      | 转向电机[4]停止代码 |

##  附录

### 保持寄存器列表

| 地址    | 数据类型 | 参数范围         | 默认值       | 备注                            |
| ------- | -------- | ---------------- | ------------ | ------------------------------- |
|         |          | 节点参数区域     |              |                                 |
| 01D     | uint16   | 0~128            | 1~节点数     | 设置需操作的节点ID              |
| 02D~10D | uint16   | ...              | ...          | CAN保留区域                     |
|         |          | 电机参数区域     |              |                                 |
| 11D     | uint16   | 1~7              | 0            | 设置电机模式                    |
| 12D~13D | int32    | 无               | 0            | 设置原点偏移值 单位PUU          |
| 14D     | uint16   | 0 ~ 35           | 34           | 回原方式                        |
| 15D     | uint16   | 1 ~ 2000         | 100          | 寻找原点开关速度 单位rpm        |
| 16D     | uint16   | 1 ~ 500          | 20           | 寻找 Z脉冲速度     单位rpm      |
| 17D     | int16    | 无               | 0            | 电机运动参数1                   |
| 18D     | int16    | 无               | 0            | 电机运动参数2                   |
| 19D     | int16    | 无               | 0            | 电机运动参数3                   |
| 20D     | int16    | 无               | 0            | 电机运动参数4                   |
| 21D     | int16    | 无               | 0            | 电机运动参数5                   |
| 22D~30D | uint16   | ...              | ...          | 电机保留区域                    |
|         |          | 心跳时间参数区域 |              |                                 |
| 31D     | uint16   | 无               | 0            | 年                              |
| 32D     | uint16   | 无               | 0            | 月                              |
| 33D     | uint16   | 无               | 0            | 日                              |
| 34D     | uint16   | 无               | 0            | 时                              |
| 35D     | uint16   | 无               | 0            | 分                              |
| 36D     | uint16   | 无               | 0            | 秒                              |
| 37D     | uint16   | 无               | 0            | 上位机心跳写入                  |
| 38D     | uint16   | 无               | 0            | 调试口心跳写入                  |
| 39D     | uint16   | 无               | 0            | 保留                            |
| 40D     | uint16   | 无               | 0            | 保留                            |
|         |          | 转向电机区域     |              |                                 |
| 41D~42D | float    | -180~180         | 当前反馈角度 | 转向电机[1]角度输入 单位:0.001° |
| 43D~44D | float    | -180~180         | 当前反馈角度 | 转向电机[2]角度输入 单位:0.001° |
| 45D~46D | float    | -180~180         | 当前反馈角度 | 转向电机[3]角度输入 单位:0.001° |
| 47D~48D | float    | -180~180         | 当前反馈角度 | 转向电机[4]角度输入 单位:0.001° |
| 49D     | uint16   | 0~20000          | 600          | 转向电机[1]速度输入 单位:0.1RPM |
| 50D     | uint16   | 0~20000          | 600          | 转向电机[2]速度输入 单位:0.1RPM |
| 51D     | uint16   | 0~20000          | 600          | 转向电机[3]速度输入 单位:0.1RPM |
| 52D     | uint16   | 0~20000          | 600          | 转向电机[4]速度输入 单位:0.1RPM |
| 53D     | int16    | 无               | 180          | 转向电机[1]最大角度 单位:°      |
| 54D     | int16    | 无               | -180         | 转向电机[1]最小角度 单位:°      |
| 55D     | int16    | 无               | 180          | 转向电机[2]最大角度 单位:°      |
| 56D     | int16    | 无               | -180         | 转向电机[2]最小角度 单位:°      |
| 57D     | int16    | 无               | 180          | 转向电机[3]最大角度 单位:°      |
| 58D     | int16    | 无               | -180         | 转向电机[3]最小角度 单位:°      |
| 59D     | int16    | 无               | 180          | 转向电机[4]最大角度 单位:°      |
| 60D     | int16    | 无               | -180         | 转向电机[4]最小角度 单位:°      |
|         |          |                  |              |                                 |
|         |          |                  |              |                                 |
|         |          |                  |              |                                 |
|         |          |                  |              |                                 |
|         |          |                  |              |                                 |
|         |          |                  |              |                                 |

### 输入寄存器列表

| 地址    | 数据类型 | 参数范围       | 默认值 | 备注                            |
| ------- | -------- | -------------- | ------ | ------------------------------- |
|         |          | 节点参数区域   |        |                                 |
| 01D     | uint16   | 1~128          | 1      | 总线节点数量                    |
| 02D     | uint16   | enum_nodeState | 0x0F   | 节点状态                        |
| 03D~06D | string   | 无             | 无     | 节点名称                        |
| 07D     | uint16   | 无             | 0x00   | 节点错误代码                    |
| 08D~10D | uint16   | 无             | 0x00   | 节点具体错误                    |
|         |          | 电机参数区域   |        |                                 |
| 11D     | uint16_t | 无             | 0      | 控制指令                        |
| 12D     | uint16_t | 无             | 0      | 状态位                          |
| 13D~14D | int32_t  | 无             | 0      | 当前位置 单位:PUU               |
| 15D~16D | int32_t  | 无             | 0      | 当前速度 单位:0.1RPM            |
| 17D~20D | uint16   | 无             | 0      | 电机保留区域                    |
|         |          | 芯片参数区域   |        |                                 |
| 21D~25D | string   | 无             | 0      | 代码编译版本                    |
| 26D~27D | uint32   | 无             | 0      | 代码编译日期                    |
| 28D~33D | 96bit    | 无             | 0      | 芯片ID                          |
| 34D~35D | uint32   | 无             | 0      | 驱动库版本                      |
| 36D~37D | uint32   | 无             | 0      | 芯片运行时间 单位ms             |
| 38D     | uint16   | 无             | 0      | 芯片复位次数                    |
| 39D     | uint16   | 无             | 0      | MODBUS通信周期 单位ms           |
| 40D     | uint16   | 无             | 0      | 保留区域                        |
|         |          |                |        |                                 |
|         |          | 转向电机区域   |        |                                 |
| 41D~42D | float    | -180~180       | 0      | 转向电机[1]反馈角度 单位:0.001° |
| 43D~44D | float    | -180~180       | 0      | 转向电机[2]反馈角度 单位:0.001° |
| 45D~46D | float    | -180~180       | 0      | 转向电机[3]反馈角度 单位:0.001° |
| 47D~48D | float    | -180~180       | 0      | 转向电机[4]反馈角度 单位:0.001° |
| 49D     | int16    | 无             | 0      | 转向电机[1]反馈速度 单位:0.1RPM |
| 50D     | int16    | 无             | 0      | 转向电机[2]反馈速度 单位:0.1RPM |
| 51D     | int16    | 无             | 0      | 转向电机[3]反馈速度 单位:0.1RPM |
| 52D     | int16    | 无             | 0      | 转向电机[4]反馈速度 单位:0.1RPM |
| 53D     | uint16   | 无             | 0      | 转向电机[1]停止代码             |
| 54D     | uint16   | 无             | 0      | 转向电机[2]停止代码             |
| 55D     | uint16   | 无             | 0      | 转向电机[3]停止代码             |
| 56D     | uint16   | 无             | 0      | 转向电机[4]停止代码             |
| 57D~60D | uint16   | 无             | 0      | 转向电机保留区域                |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |

### 线圈寄存器

| 地址    | 默认值 | 备注         |
| ------- | ------ | ------------ |
| 01D     | 0X00   | 电机使能控制 |
| 02D     | 0X01   | 电机禁用控制 |
| 03D~10D | 0X00   | 调试保留区域 |
| 11D     | 0X01   | 转向电机使能 |
|         |        |              |
|         |        |              |
|         |        |              |
|         |        |              |
|         |        |              |

### 离散输入线圈寄存器

| 地址    | 默认值 | 备注                        |
| ------- | ------ | --------------------------- |
| 01D     | 0X00   | 心跳报警标志                |
| 02D~05D | 0X00   | 心跳保留区域                |
| 06D     | 0X00   | 转向电机[1]角度超出范围标志 |
| 07D     | 0X00   | 转向电机[2]角度超出范围标志 |
| 08D     | 0X00   | 转向电机[3]角度超出范围标志 |
| 09D     | 0X00   | 转向电机[4]角度超出范围标志 |
|         |        |                             |
|         |        |                             |
|         |        |                             |
