# 激光叉车MODBUS通讯说明

[TOC]



## 版本修订履历

| 版本号 | 修订日期   | 修订作者 | 修订内容     |
| ------ | ---------- | -------- | ------------ |
| V1.0.0 | 2022/11/21 | Hly      | 创建基础版本 |

|      |      |      |      |      |
| ---- | ---- | ---- | ---- | ---- |
|      |      |      |      |      |
|      |      |      |      |      |

## 1.时间同步与心跳设置

### 1.1 时间同步

- 对保持寄存器地址41D~42D写入当前系统的时间戳，已保持时间同步与保证系统日志的有效性。
- 时间1秒发送一次，以保证时间准确性。
- 写入时间将会更改系统的RTC时间设置，已调整系统日志的时间，保证日志准确性。

| 保持寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注 |
| -------------- | -------- | -------- | ------ | ---- |
| 41D            | uint16   | 无       | 0      | 年   |
| 42D            | uint16   | 无       | 0      | 月   |
| 43D            | uint16   | 无       | 0      | 日   |
| 44D            | uint16   | 无       | 0      | 时   |
| 45D            | uint16   | 无       | 0      | 分   |
| 46D            | uint16   | 无       | 0      | 秒   |

### 1. 2 心跳设置

- 上位机对1秒对保持寄存器地址47D写入心跳状态
- 心跳状态写入如下，已通知单片机是否可以进行操作
- 单片机本地2秒清零一次心跳值，若下次清零前，没有进行赋值，则心跳同步失败。

```c
/* The nodes states 
 * -----------------
 * values are choosen so, that they can be sent directly
 * for heartbeat messages...
 * Must be coded on 7 bits only
 * */
/* Should not be modified */
enum enum_nodeState {
  Initialisation  = 0x00, //节点上电
  Disconnected    = 0x01, //节点丢失
  Connecting      = 0x02, //节点连接
  Preparing       = 0x02, //节点准备阶段
  Stopped         = 0x04, //节点停止
  Operational     = 0x05, //节点可操作状态
  Pre_operational = 0x7F, //节点预操作状态
  Unknown_state   = 0x0F  //节点未知状态
};
```



| 保持寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注           |
| -------------- | -------- | -------- | ------ | -------------- |
| 47D            | uint16   | 无       | 0      | 上位机心跳写入 |
| 48D            | uint16   | 无       | 0      | 调试口心跳写入 |
| 49D            | uint16   | 无       | 0      | 保留           |
| 50D            | uint16   | 无       | 0      | 保留           |
|                |          |          |        |                |
|                |          |          |        |                |

## 2. 电机运动控制

### 2.1 转向电机运动控制

####  2.1.1 转向电机使能

- 默认上电即使能电机，既可控制电机运动
- 对线圈寄存器地址11D写入0X01，使能电机，控制电机运动
- 写入0X00，禁用电机，禁用电机将关闭电机使能状态，禁用电机运动。

| 线圈寄存器地址 | 默认值 | 备注         |
| -------------- | ------ | ------------ |
| 11D            | 0X01   | 转向电机使能 |

#### 2.1.2 转向电机运动

- 设置电机角度,默认值为当前反馈角度。单位:0.001°
- 角度范围默认-180~180度，超出角度范围将只能运动到最大角度范围，并反馈角度超出范围标志。

| 保持寄存器地址 | 数据类型 | 参数范围 | 默认值       | 备注                            |
| -------------- | -------- | -------- | ------------ | ------------------------------- |
| 31D~32D        | float    | -180~180 | 当前反馈角度 | 转向电机[1]角度输入 单位:0.001° |
| 33D~34D        | float    | -180~180 | 当前反馈角度 | 转向电机[2]角度输入 单位:0.001° |
| 35D~36D        | float    | -180~180 | 当前反馈角度 | 转向电机[3]角度输入 单位:0.001° |
| 37D~38D        | float    | -180~180 | 当前反馈角度 | 转向电机[4]角度输入 单位:0.001° |

- 转向电机角度超出范围标志 ，保存至离散线圈输入寄存器地址0X01D中。
- 0x00,角度未超出范围。0x01,角度超出范围。
- 当输入角度在范围内时，超出范围标志自动清零。

| 离散线圈输入寄存器地址 | 默认值 | 备注                        |
| ---------------------- | ------ | --------------------------- |
| 01D                    | 0X00   | 转向电机[1]角度超出范围标志 |
| 02D                    | 0X00   | 转向电机[2]角度超出范围标志 |
| 03D                    | 0X00   | 转向电机[3]角度超出范围标志 |
| 04D                    | 0X00   | 转向电机[4]角度超出范围标志 |

- 设置电机速度，单位:0.1RPM,默认值60RPM,范围：0~2000RPM

| 保持寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                            |
| -------------- | -------- | -------- | ------ | ------------------------------- |
| 39D            | uint16   | 0~20000  | 600    | 转向电机[1]速度输入 单位:0.1RPM |
| 40D            | uint16   | 0~20000  | 600    | 转向电机[2]速度输入 单位:0.1RPM |
| 41D            | uint16   | 0~20000  | 600    | 转向电机[3]速度输入 单位:0.1RPM |
| 42D            | uint16   | 0~20000  | 600    | 转向电机[4]速度输入 单位:0.1RPM |

### 2.1.3 转向电机反馈信息

- 转向电机角度查询

| 输入寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                             |
| -------------- | -------- | -------- | ------ | -------------------------------- |
| 51D~52D        | float    | -180~180 | 0      | 转向电机[1]反馈角度  单位:0.001° |
| 53D~54D        | float    | -180~180 | 0      | 转向电机[2]反馈角度 单位:0.001°  |
| 55D~56D        | float    | -180~180 | 0      | 转向电机[3]反馈角度 单位:0.001°  |
| 57D~58D        | float    | -180~180 | 0      | 转向电机[4]反馈角度 单位:0.001°  |
|                |          |          |        |                                  |

- 转向电机速度查询

| 输入寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                            |
| -------------- | -------- | -------- | ------ | ------------------------------- |
| 59D            | int16    | 无       | 0      | 转向电机[1]反馈速度 单位:0.1RPM |
| 60D            | int16    | 无       | 0      | 转向电机[2]反馈速度 单位:0.1RPM |
| 61D            | int16    | 无       | 0      | 转向电机[3]反馈速度 单位:0.1RPM |
| 62D            | int16    | 无       | 0      | 转向电机[4]反馈速度 单位:0.1RPM |

##  附录

### 保持寄存器列表

| 地址    | 数据类型 | 参数范围     | 默认值       | 备注                            |
| ------- | -------- | ------------ | ------------ | ------------------------------- |
|         |          | 节点参数区域 |              |                                 |
| 01D     | uint16   | 0~128        | 1~节点数     | 设置需操作的节点ID              |
| 02D~10D | uint16   | ...          | ...          | CAN保留区域                     |
|         |          | 电机参数区域 |              |                                 |
| 11D     | uint16   | 1~7          | 0            | 设置电机模式                    |
| 12D~13D | int32    | 无           | 0            | 设置原点偏移值 单位PUU          |
| 14D     | uint16   | 0 ~ 35       | 34           | 回原方式                        |
| 15D     | uint16   | 1 ~ 2000     | 100          | 寻找原点开关速度 单位0.1rpm     |
| 16D     | uint16   | 1 ~ 500      | 20           | 寻找 Z脉冲速度     单位0.1rpm   |
| 17D     | int16    | 无           | 0            | 电机运动参数1                   |
| 18D     | int16    | 无           | 0            | 电机运动参数2                   |
| 19D     | int16    | 无           | 0            | 电机运动参数3                   |
| 20D     | int16    | 无           | 0            | 电机运动参数4                   |
| 21D     | int16    | 无           | 0            | 电机运动参数5                   |
| 22D~30D | uint16   | ...          | ...          | 电机保留区域                    |
|         |          | 转向电机区域 |              |                                 |
| 31D~32D | float    | -180~180     | 当前反馈角度 | 转向电机[1]角度输入 单位:0.001° |
| 33D~34D | float    | -180~180     | 当前反馈角度 | 转向电机[2]角度输入 单位:0.001° |
| 35D~36D | float    | -180~180     | 当前反馈角度 | 转向电机[3]角度输入 单位:0.001° |
| 37D~38D | float    | -180~180     | 当前反馈角度 | 转向电机[4]角度输入 单位:0.001° |
| 39D     | uint16   | 0~20000      | 600          | 转向电机[1]速度输入 单位:0.1RPM |
| 40D     | uint16   | 0~20000      | 600          | 转向电机[2]速度输入 单位:0.1RPM |
| 41D     | uint16   | 0~20000      | 600          | 转向电机[3]速度输入 单位:0.1RPM |
| 42D     | uint16   | 0~20000      | 600          | 转向电机[4]速度输入 单位:0.1RPM |
|         |          |              |              |                                 |
|         |          |              |              |                                 |
|         |          |              |              |                                 |
|         |          |              |              |                                 |
|         |          |              |              |                                 |

### 输入寄存器列表

| 地址    | 数据类型 | 参数范围       | 默认值 | 备注                            |
| ------- | -------- | -------------- | ------ | ------------------------------- |
|         |          | 节点参数区域   |        |                                 |
| 01D     | uint16   | 1~128          | 1      | 总线节点数量                    |
| 02D     | uint16   | enum_nodeState | 0x0F   | 节点状态                        |
| 03D~06D | string   | 无             | 无     | 节点名称                        |
| 07D     | uint16   | 无             | 0x00   | 节点错误代码                    |
| 08D~10D | uint16   | 无             | 0x00   | 节点具体错误                    |
|         |          | 电机参数区域   |        |                                 |
| 11D     | uint16_t | 无             | 0      | 控制指令                        |
| 12D     | uint16_t | 无             | 0      | 状态位                          |
| 13D~14D | int32_t  | 无             | 0      | 当前位置 单位:PUU               |
| 15D~16D | int32_t  | 无             | 0      | 当前速度 单位:0.1RPM            |
| 17D~20D | uint16   | 无             | 0      | 电机保留区域                    |
|         |          | 芯片参数区域   |        |                                 |
| 21D~25D | string   | 无             | 0      | 代码编译版本                    |
| 26D~27D | uint32   | 无             | 0      | 代码编译日期                    |
| 28D~33D | 96bit    | 无             | 0      | 芯片ID                          |
| 34D~35D | uint32   | 无             | 0      | 驱动库版本                      |
| 36D~37D | uint32   | 无             | 0      | 芯片运行时间 单位ms             |
| 38D     | uint16   | 无             | 0      | 芯片复位次数                    |
| 39D~40D | uint16   | 无             | 0      | 保留区域                        |
|         |          | 时间同步区域   |        |                                 |
| 41D     | uint16   | 无             | 0      | 年                              |
| 42D     | uint16   | 无             | 0      | 月                              |
| 43D     | uint16   | 无             | 0      | 日                              |
| 44D     | uint16   | 无             | 0      | 时                              |
| 45D     | uint16   | 无             | 0      | 分                              |
| 46D     | uint16   | 无             | 0      | 秒                              |
|         |          | 心跳同步区域   |        |                                 |
| 47D     | uint16   | 无             | 0      | 上位机心跳写入                  |
| 48D     | uint16   | 无             | 0      | 调试口心跳写入                  |
| 49D~50D | uint16   | 无             | 0      | 保留                            |
|         |          | 转向电机区域   |        |                                 |
| 51D~52D | float    | -180~180       | 0      | 转向电机[1]反馈角度 单位:0.001° |
| 53D~54D | float    | -180~180       | 0      | 转向电机[2]反馈角度 单位:0.001° |
| 55D~56D | float    | -180~180       | 0      | 转向电机[3]反馈角度 单位:0.001° |
| 57D~58D | float    | -180~180       | 0      | 转向电机[4]反馈角度 单位:0.001° |
| 59D     | int16    | 无             | 0      | 转向电机[1]反馈速度 单位:0.1RPM |
| 60D     | int16    | 无             | 0      | 转向电机[2]反馈速度 单位:0.1RPM |
| 61D     | int16    | 无             | 0      | 转向电机[3]反馈速度 单位:0.1RPM |
| 62D     | int16    | 无             | 0      | 转向电机[4]反馈速度 单位:0.1RPM |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |
|         |          |                |        |                                 |

### 线圈寄存器

| 地址    | 默认值 | 备注         |
| ------- | ------ | ------------ |
| 01D     | 0X00   | 电机使能控制 |
| 02D     | 0X01   | 电机禁用控制 |
| 03D~10D | 0X00   | 调试保留区域 |
| 11D     | 0X01   | 转向电机使能 |
|         |        |              |
|         |        |              |
|         |        |              |
|         |        |              |
|         |        |              |

### 离散输入线圈寄存器

| 地址 | 默认值 | 备注                        |      |
| ---- | ------ | --------------------------- | ---- |
| 01D  | 0X00   | 转向电机[1]角度超出范围标志 |      |
| 02D  | 0X00   | 转向电机[2]角度超出范围标志 |      |
| 03D  | 0X00   | 转向电机[3]角度超出范围标志 |      |
| 04D  | 0X00   | 转向电机[4]角度超出范围标志 |      |
|      |        |                             |      |
|      |        |                             |      |
|      |        |                             |      |
|      |        |                             |      |
|      |        |                             |      |
