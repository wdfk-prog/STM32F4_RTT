# MODBUS调试说明

[TOC]



## 版本修订履历

| 版本号 | 修订日期   | 修订作者 | 修订内容     |
| ------ | ---------- | -------- | ------------ |
| V1.0.0 | 2022/11/12 | Hly      | 创建基础版本 |

## 1.节点查看与设置

### 1.1设置节点ID

对**寄存器**地址01D写入节点ID进行节点设置。可以进行对该节点的查看与设置。并默认使用该节点ID进行其他步骤操作。

| 寄存器种类 | 地址 | 数据类型 | 参数范围                                    | 默认值 | 备注               |
| ---------- | ---- | -------- | ------------------------------------------- | ------ | ------------------ |
| 保持寄存器 | 01D  | uint16   | 1~节点数[1.1.2查看节点数](#1.1.2查看节点数) | 0X01   | 设置需操作的节点ID |

### 1.2查看节点数

读取**输入寄存器**地址01D查看总线节点数量，节点数量为本机节点(主节点)+从机节点数。

| 寄存器种类 | 地址 | 数据类型 | 参数范围 | 默认值 | 备注             |
| ---------- | ---- | -------- | -------- | ------ | ---------------- |
| 输入寄存器 | 01D  | uint16   | 1~128    | 0X01   | 查看总线节点数量 |

### 1.3查看节点当前NMT状态

NMT状态分为如下几个状态,一般节点进入Operational状态即正常，其他状态异常。

```c
/* The nodes states 
 * -----------------
 * values are choosen so, that they can be sent directly
 * for heartbeat messages...
 * Must be coded on 7 bits only
 * */
/* Should not be modified */
enum enum_nodeState {
  Initialisation  = 0x00, //节点上电
  Disconnected    = 0x01, //节点丢失
  Connecting      = 0x02, //节点连接
  Preparing       = 0x02, //节点准备阶段
  Stopped         = 0x04, //节点停止
  Operational     = 0x05, //节点可操作状态
  Pre_operational = 0x7F, //节点预操作状态
  Unknown_state   = 0x0F  //节点未知状态
};
```

读取**输入寄存器**地址02D来获取设置节点的NMT状态。默认查看主节点(节点ID = 0x01)状态，查看其他节点状态需设置节点ID。[1.1.1设置节点ID](#1.1.1设置节点ID)

| 寄存器种类 | 地址 | 数据类型 | 参数范围       | 默认值 | 备注         |
| ---------- | ---- | -------- | -------------- | ------ | ------------ |
| 输入寄存器 | 02D  | uint16   | enum_nodeState | 0x0F   | 查看节点状态 |

### 1.4查看节点名称

读取**输入寄存器**地址0X03至0X0B来获取设置节点的名称。默认查看主节点(节点ID = 0x01)名称，查看其他节点名称需设置节点ID。[1.1.1设置节点ID](#1.1.1设置节点ID)

字符串长度为8个8位数据，即占用4个输入寄存器。字符串格式为UTF-8,若显示异常，需将高低16位调换。

| 寄存器种类 | 地址        | 数据类型   | 参数范围    | 默认值 | 备注           |
| ---------- | ----------- | ---------- | ----------- | ------ | -------------- |
| 输入寄存器 | 03D~06D     | string     | 无          | 无     | 查看节点名称   |
| 输入寄存器 | 03D         | string     | 无          | 无     | 节点名称开始   |
| ........   | ........... | .......... | ........... | .....  | 节点名称中间值 |
| 输入寄存器 | 06D         | string     | 无          | 无     | 节点名称结束   |

例如查看主节点(节点ID = 0x01)的名称为"master",输入寄存器0X03至0X0B值为

| 地址 | 值(16进制) | 字符       |
| ---- | ---------- | ---------- |
| 03D  | 0X616D     | am         |
| 04D  | 0X7473     | ts         |
| 05D  | 0X7265     | re         |
| 06D  | 0X0000     | NUL (NULL) |

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\查看节点名称.png)

### 1.5查看节点错误代码

节点错误代码0X00~0XFF为自定义错误代码。

```c
/** 
  * @brief  节点错误代码
  */  
typedef enum
{
  NODEID_CONFIG_SUCCESS,      //节点配置成功
  NODEID_BACK_ONLINE,         //节点重新上线
  NODEID_CONFIG_NO_RESPOND,   //配置回复未响应，节点字典出错
  NODEID_CONFIG_NO_SEND,      //配置未发送,本地字典出错
}NODEID_ERRCODE;
```

其余错误代码为EMCY错误代码。

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\EMCY错误代码.png)

| 寄存器种类 | 地址    | 数据类型 | 参数范围 | 默认值 | 备注             |
| ---------- | ------- | -------- | -------- | ------ | ---------------- |
| 输入寄存器 | 07D     | uint16   | 无       | 0x00   | 查看节点错误代码 |
| 输入寄存器 | 08D~10D | uint16   | 无       | 0x00   | 查看节点具体错误 |

- 例如:节点2心跳错误，错误代码为0X8130,查看EMCY错误代码为**节点守护错误**.

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\节点心跳错误.png)

- 例如:节点2配置错误，错误代码为0X0002，查看枚举为**配置回复未响应，节点字典出错**.

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\节点配置错误.png)

- 节点具体错误:MEF：厂商自定义的错误代码.

  例如EMCY发送如下代码，其中厂商自定义的错误代码为：0X24 01 00 00 00

  ```shell
  11-15 13:49:32 E/master402_post_emcy: received EMCY message. Node: 02  ErrorCode: 8200  ErrorRegister: 10
  11-15 13:49:32 E/master402_post_emcy: Manufacturer Specific: 0X24 01 00 00 00
  ```

  在MODBUS上显示为:CDAB格式，需进行调换为ABCD格式。变换为：0X2401

  ```shell
  num:  8|input:  0x0124#num:  9|input:    0#num: 10|input:    0#
  ```

  



## 2.电机查看与设置

对节点ID进行设置后[1.1.1设置节点ID](#1.1.1设置节点ID)，该节点若是DS402协议，即电机节点，既可进行电机操作。

### 2.1电机控制

对**线圈寄存器**地址01D写入True使能电机控制,优先级小于禁用电机。

| 寄存器种类 | 地址 | 默认值 | 备注         |
| ---------- | ---- | ------ | ------------ |
| 线圈寄存器 | 01D  | 0X00   | 电机使能控制 |

- 对于位置规划模式和、原点复归模式来说，电机控制是单次的，需要标识完成状态和未完成状态。

  未完成状态，线圈寄存器01D地址保持当前值不变。

  完成状态，线圈寄存器01D地址本地写入0X00，已便提示该次操作完成。可以再次写入0X01进行下一次控制。

- 对于速度规划模式来说，电机控制是可持续的。由于速度没有完成状态的标识，将不会重置线圈寄存器值。若手动清除线圈寄存器值，将会停止电机运动，但不会停止使能。

- 若设置节点ID不为电机节点，将会置一线圈寄存器01D

### 2.2电机禁用

对**线圈寄存器**地址02D写入True禁用电机控制,优先级高于使用电机。禁用电机将关闭电机使能状态。

| 寄存器种类 | 地址 | 默认值 | 备注         |
| ---------- | ---- | ------ | ------------ |
| 线圈寄存器 | 02D  | 0X01   | 电机禁用控制 |

- 若设置节点ID不为电机节点，将会置一线圈寄存器02D

### 2.3电机模式设置

#### 2.3.1 模式设置说明

对**保持寄存器**地址11D写入参数进行模式设置。

```c
/*0X6060 模式设定Modes of operation定义*/
typedef enum
{
  PROFILE_POSITION_MODE       = 1,//位置规划模式
  PROFILE_VELOCITY_MODE       = 3,//速度规划模式
  PROFILE_TORQUE_MODE         = 4,//扭矩规划模式
  HOMING_MODE                 = 6,//原点复归模式
  INTERPOLATED_POSITION_MODE  = 7,//插补位置模式
}MODE_OPERATION;
```

**参数范围如下:**

| 模式            | 保持寄存器地址11D写入参数 | 备注          |
| --------------- | ------------------------- | ------------- |
| PP,位置规划模式 | 01D                       | 无附加参数    |
| PV,速度规划模式 | 03D                       | 无附加参数    |
| PT,扭矩规划模式 | 04D                       | 不可使用      |
| HM,原点复归模式 | 06D                       | 有4个附加参数 |
| IP,插补位置模式 | 07D                       | 不可使用      |

#### 2.3.2 原点复归模式，附加参数说明

| 保持寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                          |
| -------------- | -------- | -------- | ------ | ----------------------------- |
| 12D~13D        | int32    | 无       | 0      | 设置原点偏移值 单位PUU        |
| 14D            | uint16   | 0 ~ 35   | 34     | 回原方式                      |
| 15D            | uint16   | 1 ~ 2000 | 100    | 寻找原点开关速度 单位0.1rpm   |
| 16D            | uint16   | 1 ~ 500  | 20     | 寻找 Z脉冲速度     单位0.1rpm |

- 原点偏移值:单位:PUU [注意:只是把原点偏移值点当为0坐标点，并不会运动到0坐标点处]

![](C:\Users\Administrator\Desktop\STM32F4_RTT_v5.0\other\modbus\PUU.png)

- 回原方式: 范围:0 ~ 35

- 寻找原点开关速度:设定范围 0.1 ~ 200 默认值 10  单位0.1rpm

- 寻找 Z脉冲速度:     设定范围 0.1 ~ 50  默认值 2   单位0.1rpm

#### 2.3.3 电机模式相关保持寄存器列表

| 寄存器种类 | 地址    | 数据类型 | 参数范围 | 默认值 | 备注             |
| ---------- | ------- | -------- | -------- | ------ | ---------------- |
| 保持寄存器 | 11D     | uint16   | 1~7      | 0      | 设置电机模式     |
| 保持寄存器 | 12D~13D | int32    | 无       | 0      | 设置原点偏移值   |
| 保持寄存器 | 14D     | uint16   | 0~35     | 0      | 回原方式         |
| 保持寄存器 | 15D     | uint16   | 1 ~ 2000 | 10     | 寻找原点开关速度 |
| 保持寄存器 | 16D     | uint16   | 1 ~ 500  | 20     | 寻找 Z脉冲速度   |

### 2.4电机使用

- 对电机进行使能后[2.1电机控制](#2.1电机控制)，设置电机模式来对电机上电。
- 设置电机模式后，对相应电机运动参数写入进行控制电机运动。
- 对电机进行禁用后[2.2电机禁用](#2.2电机禁用)，电机掉电并清除当前设置的电机模式。

- 电机运动参数

| 寄存器种类 | 地址 | 数据类型 | 参数范围 | 默认值 | 备注          |
| ---------- | ---- | -------- | -------- | ------ | ------------- |
| 保持寄存器 | 17D  | uint16   | 无       | 0      | 电机运动参数1 |
| 保持寄存器 | 18D  | uint16   | 无       | 0      | 电机运动参数2 |
| 保持寄存器 | 19D  | uint16   | 无       | 0      | 电机运动参数3 |
| 保持寄存器 | 20D  | uint16   | 无       | 0      | 电机运动参数4 |
| 保持寄存器 | 21D  | uint16   | 无       | 0      | 电机运动参数5 |

- **注意**:在[2.1电机控制](#2.1电机控制)中置一后,对电机模式设置前，**请注意电机运动参数**是否修改为合适值。
- 电机运动参数被多个控制模式所共用，并且有进行数据拼接操作。

#### 2.4.1 PP,位置规划模式

伺服驱动器接收到由上位机传送的位置命令后，驱动器控制伺服电机到达目标位置。在位置控制模式下，上位机仅在一开始时告知驱动器目标位置、速度命令与加减速等相关设定。从命令触发到到达目标位置这中间的运动规划，都是由驱动器内部的运动命令产生器去执行。

- 对于位置规划模式来说，电机控制是单次的，需要标识完成状态和未完成状态。未完成状态，线圈寄存器01D地址保持当前值不变。完成状态，线圈寄存器01D地址本地写入0X00，已便提示该次操作完成。可以再次写入0X01进行下一次控制。
- 电机运动参数

| 寄存器种类 | 地址    | 数据类型 | 参数范围 | 默认值 | 备注                 |
| ---------- | ------- | -------- | -------- | ------ | -------------------- |
| 保持寄存器 | 11D     | uint16   | 1~7      | 0      | 设置电机模式         |
| 保持寄存器 | 17D~18D | int32    | 无       | 0      | 目标位置    单位 PUU |
| 保持寄存器 | 19D     | int16    | 无       | 60     | 速度 单位RPM         |
| 保持寄存器 | 20D     | uint16   | 0 、 1   | 0      | 运动模式             |
| 保持寄存器 | 21D     | uint16   | 0、  1   | 0      | 生效指令             |

- 目标位置:32位数据需要通过拼接方式实现。具体实现：

  ```c
  /*
   * 拼接16位为32位
   * H:16位高位
   * L:16位低位
  */
  #define MAKEINT_32(H,L) (((int32_t)(H) << 16) | (uint16_t)(L))
  ```

  **注意**:使用前请注意**反馈位置**与**目标位置**的值是否一致。不一致将会使能后立刻运动。

- 运动模式:设为0，绝对运动模式；设为1，相对运动模式。

  **注意**:相对运动模式对MODBUS暂无支持，使用CANOPEN可用。有需求另提。

- 命令立即生效指令。 设为 0，关闭命令立即生效指令 1，立刻生效，即未到达目标位置也可执行下次运动。

**函数原型如下**

```c
/**
  * @brief  控制电机以位置规划模式运动
  * @param  position:   位置    单位PUU 脉冲个数
  * @param  speed:      速度    单位RPM
  * @param  abs_rel:    运动模式。 设为0，绝对运动模式；设为1，相对运动模式
  * @param  immediately:命令立即生效指令。 设为 0，关闭命令立即生效指令 1，立刻生效，即未到达目标位置也可执行下次运动
  * @param  nodeId:节点ID
  * @retval 成功返回0X00,失败返回0XFF
  * @note   可以重复此函数用来控制电机运动不同位置。
  */
UNS8 motor_profile_position(int32_t position,int16_t speed,bool abs_rel,bool immediately,UNS8 nodeId)
```

#### 2.4.2 PV,速度规划模式

在 PV (速度规划) 模式下，上位机指定速度命令与加减速等条件，并由驱动器的运动命令产生器依据这些条件规划出运动轨迹.

- 对于速度规划模式来说，电机控制是可持续的。由于速度没有完成状态的标识，将不会重置线圈寄存器地址01D值。若手动清除线圈寄存器值，将会停止电机运动，但不会停止使能。
- 电机运动参数

| 寄存器种类 | 地址 | 数据类型 | 参数范围   | 默认值 | 备注         |
| ---------- | ---- | -------- | ---------- | ------ | ------------ |
| 保持寄存器 | 11D  | uint16   | 1~7        | 0      | 设置电机模式 |
| 保持寄存器 | 17D  | int16    | -3000~3000 | 0      | 速度 单位RPM |

- **注意**:尽量不要超过速度参数范围，单片机不会判断范围是否超出。范围值具体需查看对应电机驱动手册。

  例如:台达A3驱动器，原先速度为1000，现将速度设置为3001，将会按原设定值1000运动，并发送EMCY代码。

  详细信息为:	**8200**-> Protocol error DS301

  ​						**AL124** ->PDO所欲存取的对象字典范围错误

  ```shell
  11-15 13:53:00 E/master402_post_emcy: received EMCY message. Node: 02  ErrorCode: 8200  ErrorRegister: 10
  11-15 13:53:00 E/master402_post_emcy: Manufacturer Specific: 0X24 01 00 00 00
  
  ```

  

**函数原型**

```c
/**
  * @brief  控制电机以速度规划模式运动
  * @param  speed:      速度    单位RPM
  * @param  nodeId:节点ID
  * @retval 成功返回0X00,失败返回0XFF
  * @note   可以重复此函数用来控制电机运动不同位置。 置一od 0x2124开启S型加减速
  */
UNS8 motor_profile_velocity(int16_t speed,UNS8 nodeId)
```

#### 2.4.3 PT,扭矩规划模式

- 未编写

#### 2.4.4 HM,原点复归模式

在执行完成原点复归后，驱动器的坐标系即建立，驱动器可开始执行上位机所下达的位置命令。根据驱动器提供原点复归模式进行选择，包含找寻原点开关、正负极限、电机 Z脉冲等模式。

- 先对保持寄存器11D写入06D，进入原点复归模式.设置12D~15D相关参数,具体参数设置查看[2.2.2 原点复归模式，附加参数说明](#2.2.2 原点复归模式，附加参数说明).电机进入使能状态。设置17D参数，是否回零。

  **注意**:请等待回原结束，回原结束后将自动退出电机模式

- 对于原点复归模式来说，电机控制是单次的，需要标识完成状态和未完成状态。未完成状态，线圈寄存器01D地址保持当前值不变。完成状态，线圈寄存器01D地址本地写入0X00，已便提示该次操作完成。可以再次写入0X01进行下一次控制。

- 电机模式设置

  | 保持寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                          |
  | -------------- | -------- | -------- | ------ | ----------------------------- |
  | 12D~13D        | int32_t  | 无       | 0      | 设置原点偏移值 单位PUU        |
  | 14D            | uint16   | 0 ~ 35   | 34     | 回原方式                      |
  | 15D            | uint16   | 1 ~ 2000 | 100    | 寻找原点开关速度 单位0.1rpm   |
  | 16D            | uint16   | 1 ~ 500  | 20     | 寻找 Z脉冲速度     单位0.1rpm |

  电机运动参数

  | 寄存器种类 | 地址 | 数据类型 | 参数范围 | 默认值 | 备注             |
  | ---------- | ---- | -------- | -------- | ------ | ---------------- |
  | 保持寄存器 | 11D  | uint16   | 1~7      | 0      | 设置电机模式     |
  | 保持寄存器 | 17D  | uint16   | 0、1     | 0      | 是否返回零点     |
  | 保持寄存器 | 18D  | uint16   | 1~2000   | 60     | 回零速度 单位RPM |

- 设置原点偏移值:**注意**只是把原点偏移值点当为0坐标点，并不会运动到0坐标点处.

- 是否返回零点:0，无需返回0点位置。 zero_flag：1，返回0点位置。

- 回零速度:返回0点位置的速度

**函数原型如下**

```c
/**
  * @brief  控制电机使能并选择原点复位模式
  * @param  offest:原点偏移值 单位:PUU [注意:只是把原点偏移值点当为0坐标点，并不会运动到0坐标点处]
  * @param  method:回原方式   范围:0 ~ 35
  * @param  switch_speed:寻找原点开关速度 设定范围 0.1 ~ 200 默认值 10  单位rpm 精度:小数点后一位
  * @param  zero_speed:寻找 Z脉冲速度     设定范围 0.1 ~ 50  默认值 2   单位rpm 精度:小数点后一位
  * @param  nodeId:节点ID
  * @retval 成功返回0X00,失败返回0XFF
  * @note   None
*/
UNS8 motor_on_homing_mode(int32_t offset,uint8_t method,float switch_speed,float zero_speed,UNS8 nodeId)
/**
  * @brief  控制电机进入原点复归模式
  * @param  zero_flag：0，无需返回0点位置。 zero_flag：1，返回0点位置
  * @param  nodeId:节点ID
  * @retval 成功返回0X00,失败返回0XFF.
  * @note   None
*/
UNS8 motor_homing_mode (bool zero_flag,UNS8 nodeId)
```



#### 2.4.5 IP,插补位置模式

- 无法使用

### 2.5 电机反馈查看

- 对节点ID进行设置后[1.1.1设置节点ID](#1.1.1设置节点ID)，该节点若是DS402协议，即电机节点，既可进行查看电机相关反馈信息。

| 输入寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                 |
| -------------- | -------- | -------- | ------ | -------------------- |
| 11D            | uint16_t | 无       | 0      | 控制指令             |
| 12D            | uint16_t | 无       | 0      | 状态位               |
| 13D~14D        | int32_t  | 无       | 0      | 当前位置 单位:PUU    |
| 15D~16D        | int32_t  | 无       | 0      | 当前速度 单位 0.1RPM |
| 17D~20D        | uint16   | 无       | 0      | 电机保留区域         |

#### 2.5.1 控制指令

| 输入寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注     |
| -------------- | -------- | -------- | ------ | -------- |
| 11D            | uint16_t | 无       | 0      | 控制指令 |

详细内容:0x6040控制指令 Controlword是DS402协议对电机进行操作需要下发的命令。控制指令内包含许多功能，如 Servo On、命令触发、错误重置、紧急停止等。**在MODBUS中仅提供查看功能**，不支持设置。

```c
/*0x6040控制指令 Controlword 状态位定义*/
typedef enum
{
  WRITE_SWITCH_ON             = 1 << 0,//按下开关
  EN_VOLTAGE                  = 1 << 1,//使能电源
  QUICK_STOP                  = 1 << 2,//急停
  EN_OPERATION                = 1 << 3,//操作使能
  FAULT_RESET                 = 1 << 7,//错误重置
  HALT                        = 1 << 8,//暂停
}CONTROL_WORD;
/*位置规划模式下Controlword操作模式特定位*/
typedef enum
{
  NEW_SET_POINT               = 1 << 4,//命令触发(正缘触发)
  CHANGE_SET_IMMEDIATELY      = 1 << 5,//命令立即生效指令  设为 0，关闭命令立即生效指令
  ABS_REL                     = 1 << 6,//更改为绝对定位或相对定位  0，目标位置是一个绝对值 1，目标位置是一个相对值
}PROFILE_POSITION_CONTROLWORD;
/*插补位置模式下Controlword操作模式特定位
  Name          Value   Description
Enable ip mode    0     Interpolated position mode inactive 
                  1     Interpolated position mode active*/
typedef enum
{
   ENABLE_IP_MODE             = 1 << 4,//使能IP模式
}Interpolated_Position_CONTROLWORD;
/*原点复归模式下Controlword操作模式特定位
  Name          Value   Description
Homing          0       Homing mode inactive
operation       0 → 1  Start homing mode
star            1       Homing mode active
                1 → 0  Interrupt homing mode*/
typedef enum
{
  HOMING_OPERATION_STAR       = 1 << 4,//使能IP模式
}HOMING_CONTROLWORD;
```



#### 2.5.2 状态位

| 输入寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注   |
| -------------- | -------- | -------- | ------ | ------ |
| 12D            | uint16_t | 无       | 0      | 状态位 |

详细内容:0x6041状态位 Statusword是DS402协议中电机的状态反馈。可以通过查看该数据，了解电机当前状态，例如是否到达指定位置，是否发生错误，是否使能、上电等。

```c
/*0x6041状态位 Statusword定义*/
typedef enum
{
  READY_TO_SWITCH_ON          = 0,//准备功能启动
  READ_SWITCH_ON              = 1,//伺服准备完成
  OPERATION_ENABLED           = 2,//伺服使能
  FAULT                       = 3,//异常信号
  VOLTAGE_ENABLED             = 4,//伺服输入侧已供电
  READ_QUICK_STOP             = 5,//紧急停止 [0:开启急停 1:关闭急停]
  SWITCH_ON_DISABLED          = 6,//伺服准备功能关闭
  WARNING                     = 7,//警告信号
  REMOTE                      = 9,//远程控制
  TARGET_REACHED              = 10,//目标到达
  POSITIVE_LIMIT              = 14,//正向运转禁止极限
  NEGATIVE_LIMIT              = 15,//负向运转禁止极限
}STATUS_WORD;
/*位置规划模式下Statusword定义*/
typedef enum
{
  SET_POINT_ACKNOWLEDGE       = 12,//伺服收到命令信号
  FOLLOWING_ERROR             = 13,//追随错误
}PROFILE_POSITION_STATUSWORD;
/*插补位置模式下Statusword定义
    Name        Value   Description
ip mode active    1     Interpolated position mode active
*/
typedef enum
{
  IP_MODE_ACTIVE              = 12,//插补位置模式是否生效
}Interpolated_Position_STATUSWORD;
/*原点复归模式下Statusword定义
    Name          Value   Description
Homing attained    0      Homing mode not yet completed.
                   1      Homing mode carried out successfully

Homing error       0      No homing error
                   1      Homing error occurred;Homing mode carried out not successfully;The error cause is found by reading the error code
*/
typedef enum
{
  HOMING_ATTAINED              = 12,//回到原点
  HOMING_ERROR                 = 13,//回原错误
}HOMING_STATUSWORD;
```



#### 2.5.3 当前位置

| 输入寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注              |
| -------------- | -------- | -------- | ------ | ----------------- |
| 13D~14D        | int32_t  | 无       | 0      | 当前位置 单位:PUU |

#### 2.5.4 当前速度

| 输入寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                  |
| -------------- | -------- | -------- | ------ | --------------------- |
| 15D~16D        | int32_t  | 无       | 0      | 当前速度  单位 0.1RPM |

## 3.芯片查看与设置

- 

|      |      |      |      |      |
| ---- | ---- | ---- | ---- | ---- |
|      |      |      |      |      |
|      |      |      |      |      |
|      |      |      |      |      |
|      |      |      |      |      |
|      |      |      |      |      |
|      |      |      |      |      |
|      |      |      |      |      |

### 3.1 代码编译信息

| 输入寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注         |
| -------------- | -------- | -------- | ------ | ------------ |
| 21D~25D        | string   | 无       | 0      | 代码编译版本 |
| 26D~27D        | uint32   | 无       | 0      | 代码编译日期 |
| 28D~33D        | 96bit    | 无       | 0      | 芯片ID       |
| 34D~35D        | uint32   | 无       | 0      | 驱动库版本   |

### 3.2 芯片运行时间与复位次数

| 输入寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注                |
| -------------- | -------- | -------- | ------ | ------------------- |
| 36D~37D        | uint32   | 无       | 0      | 芯片运行时间 单位ms |
| 38D            | uint16   | 无       | 0      | 芯片复位次数        |

## 4.时间同步与心跳设置

### 4.1 时间同步

- 对保持寄存器地址41D~42D写入当前系统的时间戳，已保持时间同步与保证系统日志的有效性。
- 时间1秒发送一次，以保证时间准确性。
- 写入时间将会更改系统的RTC时间设置，已调整系统日志的时间，保证日志准确性。

| 保持寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注 |
| -------------- | -------- | -------- | ------ | ---- |
| 41D            | uint16   | 无       | 0      | 年   |
| 42D            | uint16   | 无       | 0      | 月   |
| 43D            | uint16   | 无       | 0      | 日   |
| 44D            | uint16   | 无       | 0      | 时   |
| 45D            | uint16   | 无       | 0      | 分   |
| 46D            | uint16   | 无       | 0      | 秒   |

### 4. 2 心跳设置

- 上位机对1秒对保持寄存器地址47D写入心跳状态
- 心跳状态写入如下，已通知单片机是否可以进行操作
- 单片机本地2秒清零一次心跳值，若下次清零前，没有进行赋值，则心跳同步失败。

```c
/* The nodes states 
 * -----------------
 * values are choosen so, that they can be sent directly
 * for heartbeat messages...
 * Must be coded on 7 bits only
 * */
/* Should not be modified */
enum enum_nodeState {
  Initialisation  = 0x00, //节点上电
  Disconnected    = 0x01, //节点丢失
  Connecting      = 0x02, //节点连接
  Preparing       = 0x02, //节点准备阶段
  Stopped         = 0x04, //节点停止
  Operational     = 0x05, //节点可操作状态
  Pre_operational = 0x7F, //节点预操作状态
  Unknown_state   = 0x0F  //节点未知状态
};
```



| 保持寄存器地址 | 数据类型 | 参数范围 | 默认值 | 备注           |
| -------------- | -------- | -------- | ------ | -------------- |
| 47D            | uint16   | 无       | 0      | 上位机心跳写入 |
| 48D            | uint16   | 无       | 0      | 调试口心跳写入 |
| 49D            | uint16   | 无       | 0      | 保留           |
| 50D            | uint16   | 无       | 0      | 保留           |
|                |          |          |        |                |
|                |          |          |        |                |

##  附录

### 保持寄存器列表

| 地址    | 数据类型 | 参数范围     | 默认值   | 备注                          |
| ------- | -------- | ------------ | -------- | ----------------------------- |
|         |          | 节点参数区域 |          |                               |
| 01D     | uint16   | 0~128        | 1~节点数 | 设置需操作的节点ID            |
| 02D~10D | uint16   | ...          | ...      | CAN保留区域                   |
|         |          | 电机参数区域 |          |                               |
| 11D     | uint16   | 1~7          | 0        | 设置电机模式                  |
| 12D~13D | int32    | 无           | 0        | 设置原点偏移值 单位PUU        |
| 14D     | uint16   | 0 ~ 35       | 34       | 回原方式                      |
| 15D     | uint16   | 1 ~ 2000     | 100      | 寻找原点开关速度 单位0.1rpm   |
| 16D     | uint16   | 1 ~ 500      | 20       | 寻找 Z脉冲速度     单位0.1rpm |
| 17D     | int16    | 无           | 0        | 电机运动参数1                 |
| 18D     | int16    | 无           | 0        | 电机运动参数2                 |
| 19D     | int16    | 无           | 0        | 电机运动参数3                 |
| 20D     | int16    | 无           | 0        | 电机运动参数4                 |
| 21D     | int16    | 无           | 0        | 电机运动参数5                 |
| 22D~30D | uint16   | ...          | ...      | 电机保留区域                  |
|         |          | 其它参数区域 |          |                               |
|         |          |              |          |                               |
|         |          |              |          |                               |
|         |          |              |          |                               |
|         |          |              |          |                               |
|         |          |              |          |                               |

### 输入寄存器列表

| 地址    | 数据类型 | 参数范围       | 默认值 | 备注                 |
| ------- | -------- | -------------- | ------ | -------------------- |
|         |          | 节点参数区域   |        |                      |
| 01D     | uint16   | 1~128          | 1      | 总线节点数量         |
| 02D     | uint16   | enum_nodeState | 0x0F   | 节点状态             |
| 03D~06D | string   | 无             | 无     | 节点名称             |
| 07D     | uint16   | 无             | 0x00   | 节点错误代码         |
| 08D~10D | uint16   | 无             | 0x00   | 节点具体错误         |
|         |          | 电机参数区域   |        |                      |
| 11D     | uint16_t | 无             | 0      | 控制指令             |
| 12D     | uint16_t | 无             | 0      | 状态位               |
| 13D~14D | int32_t  | 无             | 0      | 当前位置 单位:PUU    |
| 15D~16D | int32_t  | 无             | 0      | 当前速度 单位:0.1RPM |
| 17D~20D | uint16   | 无             | 0      | 电机保留区域         |
|         |          | 芯片参数区域   |        |                      |
| 21D~25D | string   | 无             | 0      | 代码编译版本         |
| 26D~27D | uint32   | 无             | 0      | 代码编译日期         |
| 28D~33D | 96bit    | 无             | 0      | 芯片ID               |
| 34D~35D | uint32   | 无             | 0      | 驱动库版本           |
| 36D~37D | uint32   | 无             | 0      | 芯片运行时间 单位ms  |
| 38D     | uint16   | 无             | 0      | 芯片复位次数         |
| 39D~40D | uint16   | 无             | 0      | 保留区域             |
|         |          | 时间同步区域   |        |                      |
| 41D     | uint16   | 无             | 0      | 年                   |
| 42D     | uint16   | 无             | 0      | 月                   |
| 43D     | uint16   | 无             | 0      | 日                   |
| 44D     | uint16   | 无             | 0      | 时                   |
| 45D     | uint16   | 无             | 0      | 分                   |
| 46D     | uint16   | 无             | 0      | 秒                   |
|         |          | 心跳同步区域   |        |                      |
| 47D     | uint16   | 无             | 0      | 上位机心跳写入       |
| 48D     | uint16   | 无             | 0      | 调试口心跳写入       |
| 49D~50D | uint16   | 无             | 0      | 保留                 |
|         |          |                |        |                      |
|         |          |                |        |                      |
|         |          |                |        |                      |

### 线圈寄存器

| 地址 | 默认值 | 备注         |
| ---- | ------ | ------------ |
| 01D  | 0X00   | 电机使能控制 |
| 02D  | 0X01   | 电机禁用控制 |
|      |        |              |
|      |        |              |

### 离散输入线圈寄存器

| 地址 | 默认值 | 备注 |      |
| ---- | ------ | ---- | ---- |
|      |        |      |      |
|      |        |      |      |
